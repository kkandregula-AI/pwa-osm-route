<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>DriveNav Pro</title>

<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="theme-color" content="#111827"/>

<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="data:,">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{margin:0;font-family:-apple-system,system-ui;background:#f6f7fb}
header{background:#111827;color:#fff;padding:14px;font-weight:900}
#map{height:55vh}
.controls{padding:12px}
input{width:100%;padding:12px;border-radius:12px;border:1px solid #ddd;margin-bottom:8px}
button{padding:12px;border:none;border-radius:12px;background:#111827;color:#fff;font-weight:800;margin-right:6px}
.status{margin-top:10px;font-weight:700}
.turn{background:#0b1220;color:#fff;padding:12px;border-radius:14px;margin-top:10px;display:none}
.turn h3{margin:0 0 6px 0;font-size:14px}
.turn p{margin:0;font-size:16px;font-weight:900}
</style>
</head>
<body>

<header>DriveNav Pro</header>

<div class="controls">
<input id="destination" placeholder="Enter destination"/>
<button id="routeBtn">Show Route</button>
<button id="navBtn" disabled>Start Navigation</button>
<button id="clearBtn">Clear</button>

<div class="status">
<span id="distance">Distance: —</span> |
<span id="eta">ETA: —</span> |
<span id="state">Ready</span>
</div>

<div class="turn" id="turnPanel">
<h3>Next</h3>
<p id="turnText">—</p>
</div>
</div>

<div id="map"></div>

<script>
const map=L.map("map").setView([19.076,72.8777],12);
L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

const OSRM="https://router.project-osrm.org/route/v1/driving/";
const NOMINATIM="https://nominatim.openstreetmap.org/search?format=json&limit=1&q=";

let routeLine=null,userMarker=null,startLL=null,destLL=null;
let routeCoords=[],routeDuration=0,routeDistance=0;
let watchId=null,steps=[],cumDist=[];
let rerouting=false,lastReroute=0,offCount=0;

const OFF_METERS=60;
const COOLDOWN=20000;

function speak(text){
  if(!window.speechSynthesis) return;
  const u=new SpeechSynthesisUtterance(text);
  u.rate=1;
  speechSynthesis.speak(u);
}

function hav(a,b){
  const R=6371000;
  const toRad=x=>x*Math.PI/180;
  const dLat=toRad(b[0]-a[0]);
  const dLon=toRad(b[1]-a[1]);
  const lat1=toRad(a[0]);
  const lat2=toRad(b[0]);
  const s=Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(s));
}

function project(p,a,b){
  const toXY=([lat,lon])=>[lon,lat];
  const P=toXY(p),A=toXY(a),B=toXY(b);
  const AB=[B[0]-A[0],B[1]-A[1]];
  const AP=[P[0]-A[0],P[1]-A[1]];
  const ab2=AB[0]*AB[0]+AB[1]*AB[1];
  const t=ab2===0?0:(AP[0]*AB[0]+AP[1]*AB[1])/ab2;
  const tc=Math.max(0,Math.min(1,t));
  const proj=[A[0]+AB[0]*tc,A[1]+AB[1]*tc];
  return [proj[1],proj[0]];
}

function snap(point){
  let best=routeCoords[0],bestDist=Infinity,index=0;
  for(let i=0;i<routeCoords.length-1;i++){
    const s=project(point,routeCoords[i],routeCoords[i+1]);
    const d=hav(point,s);
    if(d<bestDist){bestDist=d;best=s;index=i;}
  }
  return {snapped:best,distance:bestDist,index};
}

function buildSteps(json){
  const raw=json.routes[0].legs[0].steps||[];
  let acc=0;
  steps=raw.map(s=>{
    acc+=s.distance;
    return {instruction:s.maneuver.type+" "+(s.name||""),distance:s.distance,cum:acc};
  });
}

function remaining(index){
  let sum=0;
  for(let i=index;i<routeCoords.length-1;i++)
    sum+=hav(routeCoords[i],routeCoords[i+1]);
  return sum;
}

async function route(){
  if(!destLL) return alert("Enter destination");
  if(!startLL){
    const pos=await new Promise((res,rej)=>{
      navigator.geolocation.getCurrentPosition(p=>res([p.coords.latitude,p.coords.longitude]),rej,{enableHighAccuracy:true});
    });
    startLL=pos;
  }

  const url=OSRM+`${startLL[1]},${startLL[0]};${destLL[1]},${destLL[0]}?overview=full&geometries=geojson&steps=true`;
  const r=await fetch(url).then(r=>r.json());
  const data=r.routes[0];
  routeDuration=data.duration;
  routeDistance=data.distance;
  routeCoords=data.geometry.coordinates.map(c=>[c[1],c[0]]);

  if(routeLine) map.removeLayer(routeLine);
  routeLine=L.polyline(routeCoords,{color:"#2563eb",weight:6}).addTo(map);
  map.fitBounds(routeLine.getBounds());

  buildSteps(r);

  document.getElementById("distance").innerText="Distance: "+(routeDistance/1000).toFixed(1)+" km";
  document.getElementById("eta").innerText="ETA: "+Math.round(routeDuration/60)+" min";
  document.getElementById("navBtn").disabled=false;
}

async function autoReroute(current){
  if(rerouting||Date.now()-lastReroute<COOLDOWN) return;
  rerouting=true; lastReroute=Date.now();
  startLL=current;
  await route();
  rerouting=false;
}

function startNav(){
  watchId=navigator.geolocation.watchPosition(pos=>{
    const me=[pos.coords.latitude,pos.coords.longitude];
    const {snapped,distance,index}=snap(me);

    if(userMarker) map.removeLayer(userMarker);
    userMarker=L.circleMarker(snapped,{radius:8,color:"#2563eb"}).addTo(map);
    map.panTo(snapped);

    const off=distance>OFF_METERS;
    if(off) offCount++; else offCount=0;

    if(offCount>=3) autoReroute(me);

    const rem=remaining(index);
    document.getElementById("distance").innerText="Distance: "+(rem/1000).toFixed(1)+" km";
    const eta=rem/(routeDistance/routeDuration);
    document.getElementById("eta").innerText="ETA: "+Math.round(eta/60)+" min";
    document.getElementById("state").innerText=off?"Off route":"On route";

    // Turn instruction logic
    let traveled=routeDistance-rem;
    let stepIndex=steps.findIndex(s=>traveled<=s.cum);
    if(stepIndex>=0){
      const step=steps[stepIndex];
      document.getElementById("turnPanel").style.display="block";
      document.getElementById("turnText").innerText=step.instruction;
      if(rem<step.distance+50) speak(step.instruction);
    }

  },err=>alert(err.message),{enableHighAccuracy:true});
}

document.getElementById("routeBtn").onclick=async()=>{
  const q=document.getElementById("destination").value;
  const res=await fetch(NOMINATIM+encodeURIComponent(q)).then(r=>r.json());
  if(!res.length) return alert("Not found");
  destLL=[Number(res[0].lat),Number(res[0].lon)];
  await route();
};

document.getElementById("navBtn").onclick=startNav;

document.getElementById("clearBtn").onclick=()=>{
  if(watchId) navigator.geolocation.clearWatch(watchId);
  map.eachLayer(l=>{if(l instanceof L.Polyline||l instanceof L.CircleMarker) map.removeLayer(l);});
  routeCoords=[]; steps=[];
  document.getElementById("navBtn").disabled=true;
  document.getElementById("turnPanel").style.display="none";
  document.getElementById("distance").innerText="Distance: —";
  document.getElementById("eta").innerText="ETA: —";
  document.getElementById("state").innerText="Ready";
};
</script>

</body>
</html>